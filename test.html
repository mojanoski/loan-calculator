<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Amortization Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Style for the table container to make it scrollable on smaller screens */
        .table-container {
            max-height: 400px; /* Adjust height as needed */
            overflow-y: auto;
            margin-bottom: 1rem; /* Add some space below the table */
        }
        /* Custom scrollbar for better aesthetics (optional) */
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #a0aec0; /* Tailwind gray-500 */
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #718096; /* Tailwind gray-600 */
        }
        /* Ensure sticky header for the table */
        thead th {
            position: sticky;
            top: 0;
            background-color: #e2e8f0; /* Tailwind gray-200 */
            z-index: 10;
        }
         /* Style for the message box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background-color: #fecaca; /* Tailwind red-200 */
            color: #991b1b; /* Tailwind red-800 */
            border: 1px solid #f87171; /* Tailwind red-400 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-weight: 500;
            transition: opacity 0.5s ease-out; /* Add transition for fade out */
        }

        /* Print Styles */
        @media print {
            body {
                background-color: #fff; /* White background for printing */
                font-size: 10pt; /* Adjust font size for print */
            }
            /* Hide elements not needed for printing */
            #loan-form, #printButton, .message-box, h1:first-of-type {
                display: none !important; /* Use !important to ensure hiding */
            }
            /* Ensure results are visible and take full width */
            #results {
                display: block !important; /* Override hidden class if present */
                box-shadow: none;
                border: none;
                margin-top: 0;
                padding: 0;
                max-width: 100%;
            }
             .max-w-4xl {
                max-width: 100%;
                padding: 0;
                margin: 0;
             }
             .table-container {
                max-height: none; /* Remove max height for printing */
                overflow-y: visible;
                border: none;
                box-shadow: none;
                margin-bottom: 0;
             }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            thead th {
                background-color: #e2e8f0 !important; /* Ensure header background prints */
                -webkit-print-color-adjust: exact; /* Force background color printing in Chrome/Safari */
                print-color-adjust: exact; /* Standard property */
                 position: static; /* Remove sticky for print */
            }
            th, td {
                border: 1px solid #ddd; /* Add borders for clarity */
                padding: 6px; /* Adjust padding */
            }
            .summary-grid { /* Target the summary grid */
                 grid-template-columns: repeat(3, minmax(0, 1fr)); /* Keep 3 columns */
                 gap: 1rem;
                 margin-bottom: 1rem;
            }
            .summary-item { /* Target summary items */
                 background-color: #f3f4f6 !important; /* Light gray background */
                 padding: 0.5rem;
                 border-radius: 0;
                 box-shadow: none;
                 border: 1px solid #ddd;
                 -webkit-print-color-adjust: exact;
                 print-color-adjust: exact;
            }
             h2 { /* Style headings for print */
                 text-align: center;
                 font-size: 14pt;
                 margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">Loan Amortization Calculator</h1>

        <form id="loan-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="loanAmount" class="block text-sm font-medium text-gray-700 mb-1">Loan Amount ($)</label>
                <input type="number" id="loanAmount" name="loanAmount" placeholder="e.g., 300000" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="downPayment" class="block text-sm font-medium text-gray-700 mb-1">Down Payment ($)</label>
                <input type="number" id="downPayment" name="downPayment" placeholder="e.g., 60000" value="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="interestRate" class="block text-sm font-medium text-gray-700 mb-1">Annual Interest Rate (%)</label>
                <input type="number" id="interestRate" name="interestRate" step="0.01" placeholder="e.g., 5.5" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="loanTerm" class="block text-sm font-medium text-gray-700 mb-1">Loan Term (Years)</label>
                <input type="number" id="loanTerm" name="loanTerm" placeholder="e.g., 30" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
             <div class="md:col-span-2">
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">First Payment Date</label>
                <input type="date" id="startDate" name="startDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="md:col-span-2 text-center mt-4">
                <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Calculate Schedule
                </button>
            </div>
        </form>

         <div id="messageBox" class="message-box"></div>

        <div id="results" class="hidden mt-8">
             <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4 text-center">Calculation Summary</h2>
             <div class="summary-grid grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
                 <div class="summary-item bg-gray-100 p-4 rounded-md shadow-sm">
                     <p class="text-sm font-medium text-gray-600">Monthly Payment</p>
                     <p id="monthlyPaymentResult" class="text-lg font-bold text-indigo-700"></p>
                 </div>
                 <div class="summary-item bg-gray-100 p-4 rounded-md shadow-sm">
                     <p class="text-sm font-medium text-gray-600">Total Principal Paid</p>
                     <p id="totalPrincipalResult" class="text-lg font-bold text-indigo-700"></p>
                 </div>
                 <div class="summary-item bg-gray-100 p-4 rounded-md shadow-sm">
                     <p class="text-sm font-medium text-gray-600">Total Interest Paid</p>
                     <p id="totalInterestResult" class="text-lg font-bold text-indigo-700"></p>
                 </div>
             </div>

            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4">Amortization Schedule</h2>
            <div class="table-container border border-gray-200 rounded-md shadow-sm">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month #</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Date</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Principal</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Interest</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
             <div class="text-center mt-4">
                 <button id="printButton" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Print Schedule
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const form = document.getElementById('loan-form');
        const resultsDiv = document.getElementById('results');
        const scheduleBody = document.getElementById('schedule-body');
        const monthlyPaymentResult = document.getElementById('monthlyPaymentResult');
        const totalPrincipalResult = document.getElementById('totalPrincipalResult');
        const totalInterestResult = document.getElementById('totalInterestResult');
        const messageBox = document.getElementById('messageBox');
        const printButton = document.getElementById('printButton'); // Get print button
        let messageTimeout = null; // Variable to hold the timeout ID

        // Function to display messages
        function showMessage(message, isError = true, duration = 5000) {
             // Clear any existing timeout to prevent premature hiding
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }

            messageBox.textContent = message;
            messageBox.style.backgroundColor = isError ? '#fecaca' : '#a7f3d0'; // Red-200 for error, Green-200 for success/info
            messageBox.style.color = isError ? '#991b1b' : '#065f46'; // Red-800 for error, Green-800 for success/info
            messageBox.style.borderColor = isError ? '#f87171' : '#6ee7b7'; // Red-400 for error, Green-300 for success/info
            messageBox.style.opacity = '1'; // Ensure it's fully visible
            messageBox.style.display = 'block';

            // Hide the message box after the specified duration
            // Only set timeout if duration is positive
            if (duration > 0) {
                 messageTimeout = setTimeout(() => {
                    messageBox.style.opacity = '0'; // Start fade out
                    // Wait for fade out transition to finish before hiding
                    setTimeout(() => {
                         if (messageBox.style.opacity === '0') { // Check if it wasn't shown again quickly
                            messageBox.style.display = 'none';
                         }
                    }, 500); // Match transition duration in CSS (0.5s)
                }, duration);
            }
        }

        // Function to format currency
        function formatCurrency(amount) {
            const numAmount = Number(amount);
            if (isNaN(numAmount)) {
                return '$--.--';
            }
            return numAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }

        // Function to format date as MM/DD/YYYY
        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                return '--/--/----';
            }
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }


        // Event listener for form submission
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Clear previous results and hide the results section
            scheduleBody.innerHTML = '';
            resultsDiv.classList.add('hidden');
            messageBox.style.display = 'none'; // Hide any previous messages
             if (messageTimeout) clearTimeout(messageTimeout); // Clear message timeout on new calculation

            // Get input values
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const downPayment = parseFloat(document.getElementById('downPayment').value);
            const annualInterestRate = parseFloat(document.getElementById('interestRate').value);
            const loanTermYears = parseInt(document.getElementById('loanTerm').value);
            const startDateValue = document.getElementById('startDate').value; // Get date string

            // --- Input Validation ---
            if (isNaN(loanAmount) || loanAmount <= 0) {
                showMessage('Please enter a valid positive Loan Amount.'); return;
            }
            if (isNaN(downPayment) || downPayment < 0) {
                showMessage('Please enter a valid Down Payment (0 or positive).'); return;
            }
             if (downPayment >= loanAmount) {
                showMessage('Down Payment cannot be greater than or equal to the Loan Amount.'); return;
            }
            if (isNaN(annualInterestRate) || annualInterestRate < 0) {
                showMessage('Please enter a valid non-negative Annual Interest Rate.'); return;
            }
            if (isNaN(loanTermYears) || loanTermYears <= 0) {
                showMessage('Please enter a valid positive Loan Term in years.'); return;
            }
            // Validate Start Date Input
            if (!startDateValue) {
                 showMessage('Please select a First Payment Date.'); return;
            }
            const startDate = new Date(startDateValue + 'T00:00:00'); // Ensure parsing as local time
            if (isNaN(startDate.getTime())) {
                 showMessage('Please enter a valid First Payment Date.'); return;
            }


            // --- Calculations ---
            const principal = loanAmount - downPayment;
            const monthlyInterestRate = annualInterestRate / 100 / 12;
            const numberOfPayments = loanTermYears * 12;

            let standardMonthlyPayment = 0;

            // Calculate the standard monthly payment - handle 0% interest rate case
            if (monthlyInterestRate === 0) {
                 standardMonthlyPayment = principal / numberOfPayments;
            } else {
                 const factor = Math.pow(1 + monthlyInterestRate, numberOfPayments);
                 // Added check for factor - 1 being zero or very close to zero, which can happen with extremely low rates/long terms causing NaN/Infinity
                 if (Math.abs(factor - 1) < 1e-10) {
                     standardMonthlyPayment = principal / numberOfPayments; // Approximation for very low rates
                 } else {
                     standardMonthlyPayment = principal * (monthlyInterestRate * factor) / (factor - 1);
                 }
            }
             // Check if calculated payment is valid
             if (isNaN(standardMonthlyPayment) || !isFinite(standardMonthlyPayment)) {
                showMessage('Calculation resulted in an invalid monthly payment. Check inputs (e.g., very high interest rate).');
                return;
            }


            // --- Generate Amortization Schedule ---
            let balance = principal;
            let totalInterestPaid = 0; // Initialize total interest paid

            for (let month = 1; month <= numberOfPayments; month++) {
                const interestPayment = balance * monthlyInterestRate;
                let principalPayment = standardMonthlyPayment - interestPayment;
                let currentMonthlyPayment = standardMonthlyPayment; // Use the standard payment by default

                // Adjust last payment precisely to ensure balance becomes exactly 0
                // Check if it's the last month OR if the calculated principal payment exceeds the remaining balance
                // OR if the remaining balance is very close to the principal payment (handles floating point issues)
                if (month === numberOfPayments || principalPayment > balance || Math.abs(balance - principalPayment) < 0.005) {
                    principalPayment = balance; // Pay off the exact remaining balance
                    currentMonthlyPayment = principalPayment + interestPayment; // Recalculate this month's payment
                }

                balance -= principalPayment;
                 // Handle potential floating point inaccuracies making balance slightly negative
                 // Set balance to 0 if it's very close
                if (Math.abs(balance) < 0.005) {
                    balance = 0;
                }

                // Ensure non-negative values for display, although calculations should be correct
                const displayInterest = Math.max(0, interestPayment);
                const displayPrincipal = Math.max(0, principalPayment);
                const displayPayment = Math.max(0, currentMonthlyPayment);


                totalInterestPaid += displayInterest; // Accumulate the displayed (non-negative) interest

                // Calculate payment date for the current month
                let paymentDateForMonth = new Date(startDate);
                paymentDateForMonth.setMonth(startDate.getMonth() + month -1);


                // Create table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-left">${month}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-left">${formatDate(paymentDateForMonth)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatCurrency(displayPayment)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatCurrency(displayPrincipal)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatCurrency(displayInterest)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatCurrency(balance)}</td>
                `;
                scheduleBody.appendChild(row);

                 // If balance is zero or less, stop generating rows
                if (balance <= 0) {
                    break;
                }
            }

            // --- Display Results ---
            monthlyPaymentResult.textContent = formatCurrency(standardMonthlyPayment);
            totalPrincipalResult.textContent = formatCurrency(principal);
            // *** Removed the problematic line that caused the ReferenceError ***
            // Use the accumulated totalInterestPaid from the loop, which is correct
            totalInterestResult.textContent = formatCurrency(totalInterestPaid);

            resultsDiv.classList.remove('hidden'); // Show the results section
        });

         // Event listener for print button
        printButton.addEventListener('click', function() {
            // Show a confirmation message that the click was registered
            showMessage('Attempting to open print dialog...', false, 2000); // Show info message for 2 seconds

            // Use a small timeout to allow the message to display before potential blocking by print dialog
            setTimeout(() => {
                 try {
                    window.print();
                 } catch (error) {
                     console.error("Print error:", error);
                     showMessage('Could not open print dialog. Check browser console for errors.', true);
                 }
            }, 100); // 100ms delay
        });

        // Set default start date to today for convenience
        document.addEventListener('DOMContentLoaded', (event) => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            try {
                 // Set the default value for the date input
                 document.getElementById('startDate').value = `${yyyy}-${mm}-${dd}`;
            } catch (e) {
                // Log error if the element is not found (should not happen in this structure)
                console.error("Could not set default date:", e)
            }

        });

    </script>
</body>
</html>
